#!/bin/bash
# Here do anything needed to install the service
# i.e. apt-get install -y foo  or  bzr branch http://myserver/mycode /srv/webroot
# Make sure this hook exits cleanly and is idempotent, common problems here are
# failing to account for a debconf question on a dependency, or trying to pull
# from github without installing git first.
sudo $CHARM_DIR/lib/chef_solo_install
# Create the solo.rb file
sudo $CHARM_DIR/lib/create_solo_file

# Update the config
#sudo $CHARM_DIR/lib/config_replace

sudo touch /home/ubuntu/chef-solo/node.json
sudo cat > /home/ubuntu/chef-solo/node.json <<'EOP'
{"run_list":["role[bono]"]}
EOP

# This stops the save from borking
mkdir -p /etc/chef/ohai/hints
touch /etc/chef/ohai/hints/ec2.json
sh -c "cat > /etc/chef/ohai/hints/ec2.json <<'EOP'
{}
EOP"

sudo chef-solo -c /home/ubuntu/chef-solo/solo.rb -j /home/ubuntu/chef-solo/node.json
# Update the config
#sudo $CHARM_DIR/lib/config_script > /etc/clearwater/config
#sudo $CHARM_DIR/lib/config_replace
turn_password=`config-get turn_password`

#homestead_domain=`config-get turn_password`
#sprout_domain=`config-get turn_password`
#homer_domain=`config-get turn_password`
#ellis_domain=`config-get turn_password`
#ralf_domain=`config-get turn_password`
#home_domain=`config-get turn_password`
#sas_domain=`config-get turn_password`
#enum_domain=`config-get turn_password`

#sudo mkdir /etc/clearwater
#sudo touch /etc/clearwater/config

sudo cat > /etc/clearwater/config << EOP
turn_password=$turn_password
EOP

